<!DOCTYPE html>
<html lang="pt-BR">
<head>
ย ย <meta charset="UTF-8" />
ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0" />
ย ย <title>Encrypta - Desafio Diรกrio</title>
ย ย <link rel="preconnect" href="https://fonts.googleapis.com">
ย ย <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
ย ย <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
ย ย <link rel="stylesheet" href="style.css">
</head>
<body>
ย ย <div id="loading-overlay" class="loading-overlay">
ย ย ย ย <div class="spinner"></div>
ย ย </div>

ย ย <div class="container" id="appContainer">

ย ย ย ย <div class="game-intro">
ย ย ย ย ย ย <h1 class="main-title">ENCRYPTA</h1>
ย ย ย ย ย ย <p>O jogo diรกrio de palavras criptografadas</p>
ย ย ย ย </div>

ย ย ย ย <div id="login-section" class="content-section is-visible">
ย ย ย ย ย ย <h2>Entrar</h2>
ย ย ย ย ย ย <input type="text" id="login-username" placeholder="Usuรกrio" />
ย ย ย ย ย ย <input type="password" id="login-password" placeholder="Senha" />
ย ย ย ย ย ย <button class="btn" id="btnLogin">Entrar</button>
ย ย ย ย ย ย <p>Ainda nรฃo tem conta? <a href="#" id="goRegister">Registrar</a></p>
ย ย ย ย ย ย <p id="loginMsg" class="result-message"></p>
ย ย ย ย </div>

ย ย ย ย <div id="register-section" class="content-section">
ย ย ย ย ย ย <h2>Registrar</h2>
ย ย ย ย ย ย <input type="text" id="register-username" placeholder="Usuรกrio" />
ย ย ย ย ย ย <input type="password" id="register-password" placeholder="Senha" />
ย ย ย ย ย ย <button class="btn" id="btnRegister">Criar Conta</button>
ย ย ย ย ย ย <p>Jรก tem conta? <a href="#" id="goLogin">Login</a></p>
ย ย ย ย ย ย <p id="registerMsg" class="result-message"></p>
ย ย ย ย </div>

ย ย ย ย <div id="game-section" class="content-section">
ย ย ย ย ย ย <h1 class="main-title">ENCRYPTA โ Desafio Diรกrio</h1>
ย ย ย ย ย ย <p id="welcome" class="welcome-message"></p>

ย ย ย ย ย ย <div id="alreadyPlayedMsg" class="already-played-msg">
ย ย ย ย ย ย ย ย โ๏ธ Vocรช jรก completou o desafio de hoje. Volte amanhรฃ.
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div id="instructions" class="game-instructions">
ย ย ย ย ย ย ย ย <p>
ย ย ย ย ย ย ย ย ย ย Todo dia liberamos um novo tema com <strong>3 palavras criptografadas</strong>.<br />
ย ย ย ย ย ย ย ย ย ย Vocรช precisa decifrรก-las digitando as respostas.<br />
ย ย ย ย ย ย ย ย ย ย Quanto menos tentativas e mais rรกpido concluir, <strong>maior a sua pontuaรงรฃo</strong>.
ย ย ย ย ย ย ย ย </p>
ย ย ย ย ย ย ย ย <p>
ย ย ย ย ย ย ย ย ย ย <em>Exemplo:</em> <strong>"LUA" โ "QZE"</strong>. As 3 palavras usam a mesma substituiรงรฃo de letras.
ย ย ย ย ย ย ย ย </p>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <p id="theme" class="theme-text"></p>

ย ย ย ย ย ย <div id="challenge" class="challenge-container"></div>
ย ย ย ย ย ย <button id="loadChallenge" class="btn">Carregar Desafio do Dia</button>
ย ย ย ย ย ย <button id="submitAnswers" class="btn" style="display: none;">Enviar Respostas</button>
ย ย ย ย ย ย <p id="result" class="result-message"></p>
ย ย ย ย ย ย <button id="logout" class="btn btn-danger" style="display:none;">Sair</button>

ย ย ย ย ย ย <div id="ranking-section" class="ranking-flex">
ย ย ย ย ย ย ย ย <div class="ranking-block">
ย ย ย ย ย ย ย ย ย ย <h2>๐ Diรกrio</h2>
ย ย ย ย ย ย ย ย ย ย <table id="daily-ranking" class="ranking-table">
ย ย ย ย ย ย ย ย ย ย ย ย <thead>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr><th>#</th><th>Usuรกrio</th><th>Pontos</th></tr>
ย ย ย ย ย ย ย ย ย ย ย ย </thead>
ย ย ย ย ย ย ย ย ย ย ย ย <tbody></tbody>
ย ย ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="ranking-block">
ย ย ย ย ย ย ย ย ย ย <h2>๐ Global</h2>
ย ย ย ย ย ย ย ย ย ย <table id="global-ranking" class="ranking-table">
ย ย ย ย ย ย ย ย ย ย ย ย <thead>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr><th>#</th><th>Usuรกrio</th><th>Pontos</th></tr>
ย ย ย ย ย ย ย ย ย ย ย ย </thead>
ย ย ย ย ย ย ย ย ย ย ย ย <tbody></tbody>
ย ย ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>

ย ย <script>
ย ย ย ย // ==========================================================
ย ย ย ย // JavaScript do Encrypta
ย ย ย ย // Note: As URLs dos endpoints sรฃo proxies para o Apps Script.
ย ย ย ย // ==========================================================
ย ย ย ย const CHALLENGE_URL = "/api/challenge";
ย ย ย ย const LOGIN_URL = "/api/login";
ย ย ย ย const REGISTER_URL = "/api/register";
ย ย ย ย const RANKING_URL = "/api/ranking";
ย ย ย ย // ===== URL DA SUA CLOUD FUNCTION =====
ย ย ย ย const CLOUD_FUNCTION_URL = "https://us-central1-encryptame-1.cloudfunctions.net/submitGame";

ย ย ย ย let originalWords = [];
ย ย ย ย let startTime = null;

ย ย ย ย // ===== INรCIO DA ALTERAรรO =====
ย ย ย ย /**
ย ย ย ย ย* Normaliza uma string, removendo acentos e caracteres especiais.
ย ย ย ย ย* Ex: "Pรฃo" -> "Pao"
ย ย ย ย ย* @param {string} str A string para normalizar.
ย ย ย ย ย* @returns {string} A string normalizada.
ย ย ย ย ย*/
ย ย ย ย function normalizeString(str) {
ย ย ย ย ย ย if (!str) return "";
ย ย ย ย ย ย return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
ย ย ย ย }
ย ย ย ย // ===== FIM DA ALTERAรรO =====

ย ย ย ย // Funรงรตes para mostrar/esconder o loading overlay
ย ย ย ย function showLoading() {
ย ย ย ย ย ย document.getElementById("loading-overlay").style.display = "flex";
ย ย ย ย }

ย ย ย ย function hideLoading() {
ย ย ย ย ย ย document.getElementById("loading-overlay").style.display = "none";
ย ย ย ย }

ย ย ย ย // Funรงรฃo para mostrar ou esconder seรงรตes com a nova classe 'is-visible'
ย ย ย ย function showSection(id, visible) {
ย ย ย ย ย ย const el = document.getElementById(id);
ย ย ย ย ย ย if (el) {
ย ย ย ย ย ย ย ย if (visible) {
ย ย ย ย ย ย ย ย ย ย el.classList.add('is-visible');
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย el.classList.remove('is-visible');
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // Funรงรตes de UI
ย ย ย ย function showGameUI(user) {
ย ย ย ย ย ย showSection("login-section", false);
ย ย ย ย ย ย showSection("register-section", false);
ย ย ย ย ย ย showSection("game-section", true);
ย ย ย ย ย ย document.getElementById("welcome").textContent = `๐ Bem-vindo, ${user}!`;
ย ย ย ย ย ย document.getElementById("logout").style.display = "block";
ย ย ย ย ย ย loadRanking();
ย ย ย ย }

ย ย ย ย function showDailyBlockForUser(username) {
ย ย ย ย ย ย const el = document.getElementById("alreadyPlayedMsg");
ย ย ย ย ย ย if (el) {
ย ย ย ย ย ย ย ย el.style.display = "block"; // Apenas para compatibilidade
ย ย ย ย ย ย ย ย el.classList.add('is-visible');
ย ย ย ย ย ย }
ย ย ย ย ย ย document.getElementById("instructions").style.display = "none";
ย ย ย ย ย ย document.getElementById("loadChallenge").style.display = "none";
ย ย ย ย ย ย document.getElementById("submitAnswers").style.display = "none";
ย ย ย ย ย ย const resultMsg = document.getElementById("result");
ย ย ย ย ย ย resultMsg.textContent = "";
ย ย ย ย ย ย resultMsg.classList.remove("win");
ย ย ย ย ย ย document.querySelector(".container")?.classList.add("already-played");
ย ย ย ย }

ย ย ย ย function clearDailyBlockUI() {
ย ย ย ย ย ย const el = document.getElementById("alreadyPlayedMsg");
ย ย ย ย ย ย if (el) {
ย ย ย ย ย ย ย ย el.style.display = "none"; // Apenas para compatibilidade
ย ย ย ย ย ย ย ย el.classList.remove('is-visible');
ย ย ย ย ย ย }
ย ย ย ย ย ย const resultMsg = document.getElementById("result");
ย ย ย ย ย ย resultMsg.classList.remove("daily-block");
ย ย ย ย ย ย resultMsg.classList.remove("win");
ย ย ย ย ย ย resultMsg.textContent = "";
ย ย ย ย ย ย resultMsg.style.color = "";
ย ย ย ย ย ย document.querySelector(".container")?.classList.remove("already-played");
ย ย ย ย }

ย ย ย ย function showWinMessage() {
ย ย ย ย ย ย const el = document.getElementById("alreadyPlayedMsg");
ย ย ย ย ย ย if (el) {
ย ย ย ย ย ย ย ย el.style.display = "none";
ย ย ย ย ย ย ย ย el.classList.remove('is-visible');
ย ย ย ย ย ย }
ย ย ย ย ย ย const resultMsg = document.getElementById("result");
ย ย ย ย ย ย resultMsg.classList.remove("daily-block");
ย ย ย ย ย ย resultMsg.classList.add("win");
ย ย ย ย ย ย resultMsg.textContent = "Parabรฉns, vocรช completou o desafio de hoje. Volte amanhรฃ para solucionar mais um.";
ย ย ย ย ย ย document.getElementById("loadChallenge").style.display = "none";
ย ย ย ย ย ย document.getElementById("submitAnswers").style.display = "none";
ย ย ย ย ย ย document.querySelector(".container")?.classList.add("already-played");
ย ย ย ย }

ย ย ย ย function todayString() {
ย ย ย ย ย ย return new Date().toISOString().split("T")[0];
ย ย ย ย }
ย ย ย ย function setPlayedLocalForUser(username) {
ย ย ย ย ย ย if (!username) return;
ย ย ย ย ย ย localStorage.setItem(`playedDate:${username}`, todayString());
ย ย ย ย }
ย ย ย ย function hasPlayedLocalForUser(username) {
ย ย ย ย ย ย if (!username) return false;
ย ย ย ย ย ย return localStorage.getItem(`playedDate:${username}`) === todayString();
ย ย ย ย }
ย ย ย ย function eraseCookie(name) {
ย ย ย ย ย ย document.cookie = name + "=; Max-Age=0; path=/";
ย ย ย ย }

ย ย ย ย // ==========================================================
ย ย ย ย // Persistรชncia / Sincronizaรงรฃo
ย ย ย ย // ==========================================================
ย ย ย ย async function checkLogin() {
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย showLoading();
ย ย ย ย ย ย ย ย const res = await fetch(LOGIN_URL, { credentials: "same-origin" });
ย ย ย ย ย ย ย ย const data = await res.json().catch(() => ({}));
ย ย ย ย ย ย ย ย if (data.logged && data.username) {
ย ย ย ย ย ย ย ย ย ย if (!localStorage.getItem("user")) localStorage.setItem("user", data.username);
ย ย ย ย ย ย ย ย ย ย showGameUI(data.username);
ย ย ย ย ย ย ย ย ย ย if (hasPlayedLocalForUser(data.username)) {
ย ย ย ย ย ย ย ย ย ย ย ย showDailyBlockForUser(data.username);
ย ย ย ย ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย if (data.alreadyCompletedToday) {
ย ย ย ย ย ย ย ย ย ย ย ย setPlayedLocalForUser(data.username);
ย ย ย ย ย ย ย ย ย ย ย ย showDailyBlockForUser(data.username);
ย ย ย ย ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย clearDailyBlockUI();
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย showSection("login-section", true);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } catch (err) {
ย ย ย ย ย ย ย ย console.error("checkLogin error:", err);
ย ย ย ย ย ย ย ย showSection("login-section", true);
ย ย ย ย ย ย } finally {
ย ย ย ย ย ย ย ย hideLoading();
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ย checkLogin();

ย ย ย ย document.getElementById("logout").addEventListener("click", async () => {
ย ย ย ย ย ย showLoading();
ย ย ย ย ย ย try { await fetch(LOGIN_URL, { method: "DELETE", credentials: "same-origin" }); } catch {}
ย ย ย ย ย ย eraseCookie("user");
ย ย ย ย ย ย localStorage.removeItem("user");
ย ย ย ย ย ย document.getElementById("challenge").innerHTML = "";
ย ย ย ย ย ย document.getElementById("theme").textContent = "";
ย ย ย ย ย ย clearDailyBlockUI();
ย ย ย ย ย ย location.reload();
ย ย ย ย ย ย hideLoading();
ย ย ย ย });

ย ย ย ย document.getElementById("goRegister").addEventListener("click", (e) => {
ย ย ย ย ย ย e.preventDefault();
ย ย ย ย ย ย showSection("login-section", false);
ย ย ย ย ย ย showSection("register-section", true);
ย ย ย ย });
ย ย ย ย document.getElementById("goLogin").addEventListener("click", (e) => {
ย ย ย ย ย ย e.preventDefault();
ย ย ย ย ย ย showSection("register-section", false);
ย ย ย ย ย ย showSection("login-section", true);
ย ย ย ย });

ย ย ย ย // ==========================================================
ย ย ย ย // Registro
ย ย ย ย // ==========================================================
ย ย ย ย document.getElementById("btnRegister").addEventListener("click", async () => {
ย ย ย ย ย ย const username = document.getElementById("register-username").value.trim();
ย ย ย ย ย ย const password = document.getElementById("register-password").value;
ย ย ย ย ย ย if (!username || !password) {
ย ย ย ย ย ย ย ย document.getElementById("registerMsg").textContent = "Usuรกrio e senha obrigatรณrios.";
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }
ย ย ย ย ย ย showLoading();
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const res = await fetch(REGISTER_URL, {
ย ย ย ย ย ย ย ย ย ย method: "POST", credentials: "same-origin",
ย ย ย ย ย ย ย ย ย ย headers: { "Content-Type": "application/json" },
ย ย ย ย ย ย ย ย ย ย body: JSON.stringify({ username, password })
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย const data = await res.json();
ย ย ย ย ย ย ย ย document.getElementById("registerMsg").textContent = data.message || "";
ย ย ย ย ย ย ย ย if (data.success) {
ย ย ย ย ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย ย ย ย ย const loginRes = await fetch(LOGIN_URL, {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย method: "POST", credentials: "same-origin",
ย ย ย ย ย ย ย ย ย ย ย ย ย ย headers: { "Content-Type": "application/json" },
ย ย ย ย ย ย ย ย ย ย ย ย ย ย body: JSON.stringify({ username, password })
ย ย ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย ย ย ย ย const loginData = await loginRes.json().catch(() => ({}));
ย ย ย ย ย ย ย ย ย ย ย ย if (loginData && loginData.success) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย localStorage.setItem("user", username);
ย ย ย ย ย ย ย ย ย ย ย ย ย ย showGameUI(username);
ย ย ย ย ย ย ย ย ย ย ย ย ย ย if (loginData.alreadyCompletedToday) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย setPlayedLocalForUser(username);
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย showDailyBlockForUser(username);
ย ย ย ย ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย clearDailyBlockUI();
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย document.getElementById("loadChallenge").style.display = "block";
ย ย ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย localStorage.setItem("user", username);
ย ย ย ย ย ย ย ย ย ย ย ย ย ย showGameUI(username);
ย ย ย ย ย ย ย ย ย ย ย ย ย ย clearDailyBlockUI();
ย ย ย ย ย ย ย ย ย ย ย ย ย ย document.getElementById("loadChallenge").style.display = "block";
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย } catch (err) {
ย ย ย ย ย ย ย ย ย ย ย ย console.warn("auto-login falhou:", err);
ย ย ย ย ย ย ย ย ย ย ย ย localStorage.setItem("user", username);
ย ย ย ย ย ย ย ย ย ย ย ย showGameUI(username);
ย ย ย ย ย ย ย ย ย ย ย ย clearDailyBlockUI();
ย ย ย ย ย ย ย ย ย ย ย ย document.getElementById("loadChallenge").style.display = "block";
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย document.getElementById("register-username").value = "";
ย ย ย ย ย ย ย ย ย ย document.getElementById("register-password").value = "";
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } catch (err) {
ย ย ย ย ย ย ย ย console.error("register error:", err);
ย ย ย ย ย ย ย ย document.getElementById("registerMsg").textContent = "Erro ao registrar.";
ย ย ย ย ย ย } finally {
ย ย ย ย ย ย ย ย hideLoading();
ย ย ย ย ย ย }
ย ย ย ย });

ย ย ย ย // ==========================================================
ย ย ย ย // Login
ย ย ย ย // ==========================================================
ย ย ย ย document.getElementById("btnLogin").addEventListener("click", async () => {
ย ย ย ย ย ย const username = document.getElementById("login-username").value.trim();
ย ย ย ย ย ย const password = document.getElementById("login-password").value;
ย ย ย ย ย ย if (!username || !password) {
ย ย ย ย ย ย ย ย document.getElementById("loginMsg").textContent = "Usuรกrio e senha obrigatรณrios.";
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }
ย ย ย ย ย ย showLoading();
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const res = await fetch(LOGIN_URL, {
ย ย ย ย ย ย ย ย ย ย method: "POST", credentials: "same-origin",
ย ย ย ย ย ย ย ย ย ย headers: { "Content-Type": "application/json" },
ย ย ย ย ย ย ย ย ย ย body: JSON.stringify({ username, password })
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย const data = await res.json();
ย ย ย ย ย ย ย ย document.getElementById("loginMsg").textContent = data.message || "";
ย ย ย ย ย ย ย ย if (data.success) {
ย ย ย ย ย ย ย ย ย ย localStorage.setItem("user", username);
ย ย ย ย ย ย ย ย ย ย showGameUI(username);
ย ย ย ย ย ย ย ย ย ย if (data.alreadyCompletedToday) {
ย ย ย ย ย ย ย ย ย ย ย ย setPlayedLocalForUser(username);
ย ย ย ย ย ย ย ย ย ย ย ย showDailyBlockForUser(username);
ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย clearDailyBlockUI();
ย ย ย ย ย ย ย ย ย ย ย ย document.getElementById("loadChallenge").style.display = "block";
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } catch (err) {
ย ย ย ย ย ย ย ย console.error("login error:", err);
ย ย ย ย ย ย ย ย document.getElementById("loginMsg").textContent = "Erro ao logar.";
ย ย ย ย ย ย } finally {
ย ย ย ย ย ย ย ย hideLoading();
ย ย ย ย ย ย }
ย ย ย ย });

ย ย ย ย // ==========================================================
ย ย ย ย // Carregar Desafio
ย ย ย ย // ==========================================================
ย ย ย ย document.getElementById("loadChallenge").addEventListener("click", async () => {
ย ย ย ย ย ย const username = localStorage.getItem("user");
ย ย ย ย ย ย if (!username) return;
ย ย ย ย ย ย if (hasPlayedLocalForUser(username)) {
ย ย ย ย ย ย ย ย showDailyBlockForUser(username);
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }
ย ย ย ย ย ย showLoading();
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const statusRes = await fetch(LOGIN_URL, { credentials: "same-origin" });
ย ย ย ย ย ย ย ย const status = await statusRes.json().catch(() => ({}));
ย ย ย ย ย ย ย ย if (status.logged && status.username === username && status.alreadyCompletedToday) {
ย ย ย ย ย ย ย ย ย ย setPlayedLocalForUser(username);
ย ย ย ย ย ย ย ย ย ย showDailyBlockForUser(username);
ย ย ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } catch (err) {
ย ย ย ย ย ย ย ย console.warn("status check failed:", err);
ย ย ย ย ย ย }
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const response = await fetch(CHALLENGE_URL);
ย ย ย ย ย ย ย ย const data = await response.json();
ย ย ย ย ย ย ย ย document.getElementById("theme").textContent = `Tema: ${data.theme || ""}`;
ย ย ย ย ย ย ย ย originalWords = data.original || [];
ย ย ย ย ย ย ย ย const challengeDiv = document.getElementById("challenge");
ย ย ย ย ย ย ย ย challengeDiv.innerHTML = "";
ย ย ย ย ย ย ย ย (data.words || []).forEach((word, wordIndex) => {
ย ย ย ย ย ย ย ย ย ย const wordDiv = document.createElement("div");
ย ย ย ย ย ย ย ย ย ย wordDiv.classList.add("challenge-word");
ย ย ย ย ย ย ย ย ย ย wordDiv.innerHTML = `<p>${word}</p>`;

ย ย ย ย ย ย ย ย ย ย const inputContainer = document.createElement("div");
ย ย ย ย ย ย ย ย ย ย inputContainer.classList.add("input-container");
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย for (let i = 0; i < word.length; i++) {
ย ย ย ย ย ย ย ย ย ย ย ย const input = document.createElement("input");
ย ย ย ย ย ย ย ย ย ย ย ย input.type = "text";
ย ย ย ย ย ย ย ย ย ย ย ย input.maxLength = "1";
ย ย ย ย ย ย ย ย ย ย ย ย input.classList.add("letter-input");
ย ย ย ย ย ย ย ย ย ย ย ย input.setAttribute("data-word-index", wordIndex);
ย ย ย ย ย ย ย ย ย ย ย ย input.setAttribute("data-letter-index", i);
ย ย ย ย ย ย ย ย ย ย ย ย input.addEventListener("input", (e) => {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย if (e.target.value) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย const nextInput = document.querySelector(`[data-word-index="${wordIndex}"][data-letter-index="${i + 1}"]`);
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย if (nextInput) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย nextInput.focus();
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย ย ย ย ย input.addEventListener("keydown", (e) => {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย if (e.key === "Backspace" && !e.target.value) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย const prevInput = document.querySelector(`[data-word-index="${wordIndex}"][data-letter-index="${i - 1}"]`);
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย if (prevInput) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย prevInput.focus();
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย ย ย ย ย inputContainer.appendChild(input);
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย wordDiv.appendChild(inputContainer);
ย ย ย ย ย ย ย ย ย ย challengeDiv.appendChild(wordDiv);
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย document.getElementById("instructions").style.display = "none";
ย ย ย ย ย ย ย ย document.getElementById("loadChallenge").style.display = "none";
ย ย ย ย ย ย ย ย document.getElementById("submitAnswers").style.display = "block";
ย ย ย ย ย ย ย ย clearDailyBlockUI();
ย ย ย ย ย ย ย ย document.getElementById("result").textContent = "";
ย ย ย ย ย ย ย ย startTime = Date.now();
ย ย ย ย ย ย } catch (err) {
ย ย ย ย ย ย ย ย console.error("Erro ao carregar desafio:", err);
ย ย ย ย ย ย ย ย alert("Erro ao carregar desafio do dia.");
ย ย ย ย ย ย } finally {
ย ย ย ย ย ย ย ย hideLoading();
ย ย ย ย ย ย }
ย ย ย ย });

ย ย ย ย // ==========================================================
ย ย ย ย // Verificar Respostas + Enviar Ranking
ย ย ย ย // ==========================================================
ย ย ย ย document.getElementById("submitAnswers").addEventListener("click", async () => {
ย ย ย ย ย ย showLoading();
ย ย ย ย ย ย let correctCount = 0;
ย ย ย ย ย ย originalWords.forEach((answer, wordIndex) => {
ย ย ย ย ย ย ย ย const inputs = document.querySelectorAll(`[data-word-index="${wordIndex}"]`);
ย ย ย ย ย ย ย ย let guessedWord = "";
ย ย ย ย ย ย ย ย inputs.forEach(input => guessedWord += input.value);
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // ===== INรCIO DA ALTERAรรO =====
ย ย ย ย ย ย ย ย // Normaliza ambas as strings antes de comparar
ย ย ย ย ย ย ย ย const normalizedGuessedWord = normalizeString(guessedWord).toUpperCase();
ย ย ย ย ย ย ย ย const normalizedAnswer = normalizeString(String(answer || "")).toUpperCase();
ย ย ย ย ย ย ย ย const isWordCorrect = normalizedGuessedWord === normalizedAnswer;
ย ย ย ย ย ย ย ย // ===== FIM DA ALTERAรรO =====
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // Add to correct count if the word is correct
ย ย ย ย ย ย ย ย if (isWordCorrect) {
ย ย ย ย ย ย ย ย ย ย correctCount++;
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย // Apply feedback to all inputs of the word based on the overall correctness
ย ย ย ย ย ย ย ย inputs.forEach(input => {
ย ย ย ย ย ย ย ย ย ย input.classList.add('animate-feedback');
ย ย ย ย ย ย ย ย ย ย // Remove existing feedback classes first
ย ย ย ย ย ย ย ย ย ย input.classList.remove('correct', 'wrong');
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย if (isWordCorrect) {
ย ย ย ย ย ย ย ย ย ย ย ย input.classList.add('correct');
ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย input.classList.add('wrong');
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย });

ย ย ย ย ย ย const resultMsg = document.getElementById("result");
ย ย ย ย ย ย const elapsed = startTime ? Math.floor((Date.now() - startTime) / 1000) : 0;
ย ย ย ย ย ย const points = correctCount;

ย ย ย ย ย ย const isCorrect = (correctCount === originalWords.length);

ย ย ย ย ย ย if (isCorrect) {
ย ย ย ย ย ย ย ย resultMsg.textContent = "๐ Parabรฉns! Vocรช acertou todas!";
ย ย ย ย ย ย ย ย resultMsg.style.color = "#4CAF50";
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย resultMsg.textContent = `Vocรช acertou ${correctCount} de ${originalWords.length}.`;
ย ย ย ย ย ย ย ย resultMsg.style.color = "#FFB300";
ย ย ย ย ย ย }

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const username = localStorage.getItem("user");
ย ย ย ย ย ย ย ย const payload = {
ย ย ย ย ย ย ย ย ย ย username,
ย ย ย ย ย ย ย ย ย ย challengeDate: new Date().toISOString().split("T")[0],
ย ย ย ย ย ย ย ย ย ย success: isCorrect,
ย ย ย ย ย ย ย ย ย ย elapsed,
ย ย ย ย ย ย ย ย };

ย ย ย ย ย ย ย ย const response = await fetch(CLOUD_FUNCTION_URL, {
ย ย ย ย ย ย ย ย ย ย method: "POST",
ย ย ย ย ย ย ย ย ย ย headers: { "Content-Type": "application/json" },
ย ย ย ย ย ย ย ย ย ย body: JSON.stringify(payload)
ย ย ย ย ย ย ย ย });
                const result = await response.json();
                
                if (result.status === "success" && isCorrect) {
                    setPlayedLocalForUser(username);
                    showWinMessage();
                    loadRanking();
                } else if (result.status === "continue") {
                    resultMsg.textContent += ` Vocรช usou ${result.attempts} tentativas.`;
                } else if (result.status === "error") {
                    console.error("Erro do servidor:", result.message);
                    resultMsg.textContent = `Erro: ${result.message}`;
                }
ย ย ย ย ย ย } catch (err) {
ย ย ย ย ย ย ย ย console.error("Erro ao enviar resultado:", err);
                resultMsg.textContent = "Erro ao enviar resultado. Tente novamente.";
ย ย ย ย ย ย } finally {
ย ย ย ย ย ย ย ย hideLoading();
ย ย ย ย ย ย }
ย ย ย ย });

ย ย ย ย // ==========================================================
ย ย ย ย // Carregar Ranking
ย ย ย ย // ==========================================================
ย ย ย ย async function loadRanking() {
ย ย ย ย ย ย showLoading();
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const res = await fetch(RANKING_URL);
ย ย ย ย ย ย ย ย const data = await res.json();
ย ย ย ย ย ย ย ย document.getElementById("ranking-section").style.display = "flex";
ย ย ย ย ย ย ย ย const dailyBody = document.querySelector("#daily-ranking tbody");
ย ย ย ย ย ย ย ย dailyBody.innerHTML = "";
ย ย ย ย ย ย ย ย (data.dailyTop || []).forEach((row, idx) => {
ย ย ย ย ย ย ย ย ย ย dailyBody.innerHTML += `<tr>
ย ย ย ย ย ย ย ย ย ย ย ย <td>${idx+1}</td><td>${row.username}</td><td>${row.points}</td>
ย ย ย ย ย ย ย ย ย ย </tr>`;
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย const globalBody = document.querySelector("#global-ranking tbody");
ย ย ย ย ย ย ย ย globalBody.innerHTML = "";
ย ย ย ย ย ย ย ย (data.overallTotal || []).forEach((row, idx) => {
ย ย ย ย ย ย ย ย ย ย globalBody.innerHTML += `<tr>
ย ย ย ย ย ย ย ย ย ย ย ย <td>${idx+1}</td><td>${row.username}</td><td>${row.totalPoints}</td>
ย ย ย ย ย ย ย ย ย ย </tr>`;
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย } catch (err) {
ย ย ย ย ย ย ย ย console.error("Erro ao carregar ranking:", err);
ย ย ย ย ย ย } finally {
ย ย ย ย ย ย ย ย hideLoading();
ย ย ย ย ย ย }
ย ย ย ย }
ย ย </script>
</body>
</html>
